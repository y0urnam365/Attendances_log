<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teacher Portal - Attendance</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- MODERN VARIABLES --- */
        :root {
            --bg-body: #0f172a;
            --surface: #1e293b;
            --surface-hover: #334155;
            --primary: #6366f1;   /* Indigo */
            --accent: #8b5cf6;    /* Violet */
            
            /* Status Colors */
            --present: #10b981;   /* Emerald */
            --present-bg: rgba(16, 185, 129, 0.15);
            
            --permission: #f59e0b; /* Amber */
            --permission-bg: rgba(245, 158, 11, 0.15);
            
            --absent: #ef4444;    /* Rose */
            --absent-bg: rgba(239, 68, 68, 0.15);

            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Outfit', 'Battambang', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 100px; /* Space for bottom bar */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- STICKY HEADER --- */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            width: 100%;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand p { margin: 2px 0 0; font-size: 0.8rem; color: var(--text-muted); }

        .date-group {
            position: relative;
        }

        .date-picker {
            background: var(--surface);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 10px 15px;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .date-picker:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        /* --- STUDENT LIST --- */
        .container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .student-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Dynamic Border based on Status */
        .student-card.status-present { border-left: 4px solid var(--present); }
        .student-card.status-permission { border-left: 4px solid var(--permission); }
        .student-card.status-absent { border-left: 4px solid var(--absent); }

        .avatar-container {
            position: relative;
        }

        .avatar {
            width: 55px; height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--surface-hover);
            background: var(--bg-body);
        }

        .info { flex-grow: 1; min-width: 0; }
        .name { font-weight: 600; font-size: 1.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .id { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; margin-top: 2px; }
        .id i { font-size: 0.7rem; }

        /* --- ATTENDANCE TOGGLES --- */
        .attendance-actions {
            display: flex;
            background: var(--bg-body);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .status-btn {
            border: none;
            background: transparent;
            color: var(--text-muted);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .status-btn:hover { background: rgba(255,255,255,0.05); }

        /* Active States */
        .status-btn.active-p { background: var(--present); color: #fff; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); }
        .status-btn.active-per { background: var(--permission); color: #fff; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); }
        .status-btn.active-a { background: var(--absent); color: #fff; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4); }

        /* --- BOTTOM BAR --- */
        .bottom-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            z-index: 100;
        }

        .save-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.5);
            transition: 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(4px);
        }

        .save-btn:hover { background: #4f46e5; transform: translateY(-2px); }
        .save-btn:active { transform: translateY(0); }
        .save-btn:disabled { background: var(--surface-hover); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }

        /* Loading */
        #loading { margin-top: 100px; display: flex; flex-direction: column; align-items: center; gap: 15px; color: var(--text-muted); }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .student-card { padding: 12px; gap: 12px; }
            .avatar { width: 45px; height: 45px; }
            .name { font-size: 0.95rem; }
            .status-btn { width: 36px; height: 36px; font-size: 1rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="brand">
                <h1>Class Attendance</h1>
                <p>Teacher Portal</p>
            </div>
            <div class="date-group">
                <input type="date" id="attendanceDate" class="date-picker">
            </div>
        </div>
    </header>

    <div id="loading">
        <div class="spinner"></div>
        <span>Syncing Class List...</span>
    </div>

    <div class="container" id="listContainer">
        </div>

    <div class="bottom-bar">
        <button id="saveBtn" class="save-btn" onclick="submitAttendance()">
            <i class="fas fa-cloud-upload-alt"></i> Save to Database
        </button>
    </div>

    <script>
        // --- CONFIGURATION ---
        // 1. Link សម្រាប់ទាញឈ្មោះសិស្ស
        const STUDENT_INFO_URL = 'https://docs.google.com/spreadsheets/d/19ff8RRIBXj4Qe2NaO04kibrKpGJhzZrJ5iH7Pg66Aps/gviz/tq?tqx=out:csv';
        
        // 2. SHEETDB API URL
        // TODO: ជំនួស xxxxxxxxxxxx ដោយកូដរបស់អ្នក
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/0ruy75wda1983'; 

        let studentsData = [];
        let attendanceRecord = {}; 

        // Set Date to Today
        document.getElementById('attendanceDate').valueAsDate = new Date();

        async function fetchStudents() {
            try {
                const response = await fetch(STUDENT_INFO_URL);
                const csvText = await response.text();
                studentsData = csvToJson(csvText);
                
                document.getElementById('loading').style.display = 'none';
                renderList();
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = '<span style="color:var(--absent)">Failed to load data.</span>';
            }
        }

        function renderList() {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';

            studentsData.forEach(student => {
                // Default Status = Present
                attendanceRecord[student.ID] = 'Present'; 

                const imgSrc = student.PhotoURL || '';
                
                const card = document.createElement('div');
                card.className = 'student-card status-present'; // Default class
                card.id = `card-${student.ID}`;
                
                card.innerHTML = `
                    <div class="avatar-container">
                        <img src="${imgSrc}" class="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${student.Name}&background=random&color=fff'">
                    </div>
                    <div class="info">
                        <div class="name">${student.Name}</div>
                        <div class="id"><i class="fas fa-id-badge"></i> ${student.ID}</div>
                    </div>
                    <div class="attendance-actions">
                        <button class="status-btn active-p" onclick="setStatus('${student.ID}', 'Present', this)" title="Present">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="status-btn" onclick="setStatus('${student.ID}', 'Permission', this)" title="Permission">
                            <i class="fas fa-clock"></i>
                        </button>
                        <button class="status-btn" onclick="setStatus('${student.ID}', 'Absent', this)" title="Absent">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function setStatus(id, status, btnElement) {
            // 1. Update Data
            attendanceRecord[id] = status;

            // 2. Update Visuals (Buttons)
            const parent = btnElement.parentElement;
            const buttons = parent.querySelectorAll('.status-btn');
            
            // Reset all buttons
            buttons.forEach(b => {
                b.className = 'status-btn'; 
            });

            // Set Active Class based on status
            if(status === 'Present') btnElement.classList.add('active-p');
            if(status === 'Permission') btnElement.classList.add('active-per');
            if(status === 'Absent') btnElement.classList.add('active-a');

            // 3. Update Card Border Color
            const card = document.getElementById(`card-${id}`);
            card.className = 'student-card'; // Reset
            if(status === 'Present') card.classList.add('status-present');
            if(status === 'Permission') card.classList.add('status-permission');
            if(status === 'Absent') card.classList.add('status-absent');
        }

        function submitAttendance() {
            if (SHEETDB_URL.includes('xxxxxxxxxxxx')) {
                alert("សូមដាក់ SheetDB API URL ជាមុនសិន!");
                return;
            }

            const date = document.getElementById('attendanceDate').value;
            if(!date) { alert("Please select a date!"); return; }

            const saveBtn = document.getElementById('saveBtn');
            const originalContent = saveBtn.innerHTML;
            
            saveBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
            saveBtn.disabled = true;

            const dataToSend = studentsData.map(s => ({
                "Date": date,
                "Student ID": s.ID,       
                "Student Name": s.Name,   
                "Status": attendanceRecord[s.ID]
            }));

            fetch(SHEETDB_URL, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                if(data.created || data.error === undefined) {
                    saveBtn.innerHTML = '<i class="fas fa-check-circle"></i> Saved Successfully!';
                    saveBtn.style.background = 'var(--present)';
                } else {
                    throw new Error("API Error");
                }
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalContent;
                    saveBtn.style.background = 'var(--primary)';
                    saveBtn.disabled = false;
                }, 2500);
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Connection Failed. Please check internet or API Limit.");
                saveBtn.innerHTML = '<i class="fas fa-redo"></i> Retry';
                saveBtn.style.background = 'var(--absent)';
                saveBtn.disabled = false;
            });
        }

        function csvToJson(csvText) {
            const rows = csvText.split('\n').map(row => row.trim()).filter(row => row.length > 0);
            const headers = rows[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.replace(/^"|"$/g, '').trim());
            return rows.slice(1).map(row => {
                const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const obj = {};
                headers.forEach((h, i) => obj[h] = values[i] ? values[i].replace(/^"|"$/g, '').trim() : '');
                return obj;
            });
        }

        fetchStudents();
    </script>
</body>
</html>
