<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card-bg: rgba(30, 41, 59, 0.7);
            --primary: #3b82f6;        
            --success: #10b981;        
            --warning: #f59e0b;
            --danger: #ef4444;         
            --text-light: #f8fafc;
            --text-gray: #94a3b8;
        }

        body {
            font-family: 'Poppins', 'Battambang', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Header & Date Picker */
        header { 
            width: 90%; max-width: 800px;
            margin-top: 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { margin: 0; font-size: 1.8rem; background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .date-picker {
            background: #334155;
            color: white;
            border: 1px solid #475569;
            padding: 10px 15px;
            border-radius: 10px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
        }

        /* Student List Container */
        .attendance-list {
            width: 90%;
            max-width: 800px;
            margin: 30px 0 100px 0; /* Space for fixed button */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Individual Student Row */
        .student-row {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .student-row:hover { transform: translateY(-2px); border-color: var(--primary); }

        .avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #475569;
        }

        .info { flex-grow: 1; }
        .name { font-weight: 600; font-size: 1.1rem; }
        .id { font-size: 0.85rem; color: var(--text-gray); }

        /* Attendance Buttons */
        .actions {
            display: flex;
            gap: 8px;
        }

        .status-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0.5;
            transition: 0.3s;
            color: #1e293b;
            font-family: 'Battambang', sans-serif;
        }

        .btn-p { background-color: var(--success); }
        .btn-per { background-color: var(--warning); }
        .btn-a { background-color: var(--danger); }

        /* Active State */
        .status-btn.active {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
            color: white;
        }

        /* Floating Submit Button */
        .submit-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 90%;
            max-width: 800px;
        }

        .submit-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
            transition: 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .submit-btn:hover { background: #2563eb; transform: translateY(-3px); }
        .submit-btn:disabled { background: #64748b; cursor: wait; }

        /* Loading */
        #loading { margin-top: 50px; color: var(--primary); }

    </style>
</head>
<body>

    <header>
        <div>
            <h1>Teacher Portal</h1>
            <p style="margin:0; font-size:0.9rem; color:#94a3b8;">Record Class Attendance</p>
        </div>
        <input type="date" id="attendanceDate" class="date-picker">
    </header>

    <div id="loading">Loading Students List...</div>

    <div class="attendance-list" id="listContainer"></div>

    <div class="submit-container">
        <button id="saveBtn" class="submit-btn" onclick="submitAttendance()">
            <i class="fas fa-save"></i> Save Attendance (រក្សាទុក)
        </button>
    </div>

    <script>
        // --- URL CONFIGURATION ---
        // 1. Link ទិន្នន័យសិស្ស (សម្រាប់អានឈ្មោះមកបង្ហាញ)
        const STUDENT_INFO_URL = 'https://docs.google.com/spreadsheets/d/19ff8RRIBXj4Qe2NaO04kibrKpGJhzZrJ5iH7Pg66Aps/gviz/tq?tqx=out:csv';
        
        // 2. SHEETDB API URL (សម្រាប់រក្សាទុកទិន្នន័យ)
        // TODO: សូមជំនួស xxxxxxxxxxxx ដោយកូដ API របស់អ្នកពី sheetdb.io
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/0ruy75wda1983'; 

        let studentsData = [];
        let attendanceRecord = {}; 

        // Set default date to today
        document.getElementById('attendanceDate').valueAsDate = new Date();

        async function fetchStudents() {
            try {
                const response = await fetch(STUDENT_INFO_URL);
                const csvText = await response.text();
                studentsData = csvToJson(csvText);
                
                document.getElementById('loading').style.display = 'none';
                renderList();
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerText = "Error loading student list.";
            }
        }

        function renderList() {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';

            studentsData.forEach(student => {
                // Default status is Present (P)
                attendanceRecord[student.ID] = 'Present'; 

                const imgSrc = student.PhotoURL || '';
                
                const row = document.createElement('div');
                row.className = 'student-row';
                row.innerHTML = `
                    <img src="${imgSrc}" class="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${student.Name}&background=random'">
                    <div class="info">
                        <div class="name">${student.Name}</div>
                        <div class="id">${student.ID}</div>
                    </div>
                    <div class="actions">
                        <button class="status-btn btn-p active" onclick="setStatus('${student.ID}', 'Present', this)">P</button>
                        <button class="status-btn btn-per" onclick="setStatus('${student.ID}', 'Permission', this)">Per</button>
                        <button class="status-btn btn-a" onclick="setStatus('${student.ID}', 'Absent', this)">A</button>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function setStatus(id, status, btnElement) {
            // Update Data
            attendanceRecord[id] = status;

            // Visual Update (Toggle Active Class)
            const parent = btnElement.parentElement;
            const buttons = parent.querySelectorAll('.status-btn');
            buttons.forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }

        // --- FUNCTION TO SAVE TO SHEETDB ---
        function submitAttendance() {
            // ការពារករណីមិនទាន់ដាក់ URL
            if (SHEETDB_URL.includes('xxxxxxxxxxxx')) {
                alert("សូមដាក់ SheetDB API URL របស់អ្នកជាមុនសិន!");
                return;
            }

            const date = document.getElementById('attendanceDate').value;
            if(!date) { alert("Please select a date!"); return; }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;

            // រៀបចំទិន្នន័យសម្រាប់បញ្ជូន (Format របស់ SheetDB)
            // SheetDB ត្រូវការ Array នៃ Object សម្រាប់បញ្ចូលច្រើនជួរព្រមគ្នា
            const dataToSend = studentsData.map(s => ({
                "Date": date,
                "Student ID": s.ID,       // ឈ្មោះ Key ត្រូវតែដូច Header ក្នុង Sheet
                "Student Name": s.Name,   // ឈ្មោះ Key ត្រូវតែដូច Header ក្នុង Sheet
                "Status": attendanceRecord[s.ID]
            }));

            // បញ្ជូនទៅកាន់ SheetDB
            fetch(SHEETDB_URL, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                // ប្រសិនបើជោគជ័យ SheetDB នឹងឆ្លើយតបមកវិញ
                if(data.created || data.error === undefined) {
                    alert("✅ រក្សាទុកបានជោគជ័យ! (Saved to SheetDB)");
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
                } else {
                    throw new Error("SheetDB Error");
                }
                
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Attendance (រក្សាទុក)';
                    saveBtn.disabled = false;
                }, 2000);
            })
            .catch(error => {
                console.error('Error:', error);
                alert("❌ មានបញ្ហាក្នុងការរក្សាទុក (សូមពិនិត្យមើល URL ឬ Internet)");
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Retry Save';
                saveBtn.disabled = false;
            });
        }

        function csvToJson(csvText) {
            const rows = csvText.split('\n').map(row => row.trim()).filter(row => row.length > 0);
            const headers = rows[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.replace(/^"|"$/g, '').trim());
            return rows.slice(1).map(row => {
                const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const obj = {};
                headers.forEach((h, i) => obj[h] = values[i] ? values[i].replace(/^"|"$/g, '').trim() : '');
                return obj;
            });
        }

        fetchStudents();
    </script>
</body>
</html>
